"""
EduCode Backend - Evaluation Model

Defines the Evaluation entity storing AI grading results.
Contains similarity metrics and final scores with rationale.
"""

from datetime import datetime
from typing import Optional

from sqlalchemy import Column, Integer, Float, Text, DateTime, ForeignKey
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func

from app.core.database import Base


class Evaluation(Base):
    """
    Evaluation model representing AI grading results.
    
    Stores similarity metrics and final scores generated by the AI grading system.
    Each submission gets one evaluation after the grading process completes.
    
    Attributes:
        id: Primary key
        submission_id: Foreign key to Submission (one-to-one)
        ai_similarity: Similarity score to AI-generated solutions (0.0-1.0)
        intra_group_similarity: Similarity score to other students in group (0.0-1.0)
        final_score: Final grade from AI evaluation (1-100)
        rationale: AI-generated explanation for the grade
        created_at: Timestamp when evaluation was created
        updated_at: Timestamp when evaluation was last updated
    """
    
    __tablename__ = "evaluations"
    
    # Primary key
    id = Column(Integer, primary_key=True, index=True)
    
    # Foreign key (one-to-one with submission)
    submission_id = Column(Integer, ForeignKey("submissions.id"), unique=True, nullable=False, index=True)
    
    # Similarity metrics
    ai_similarity = Column(Float, nullable=False, index=True)
    intra_group_similarity = Column(Float, nullable=False, index=True)
    
    # Final grading results
    final_score = Column(Integer, nullable=False, index=True)
    rationale = Column(Text, nullable=False)
    
    # Timestamps
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False)
    updated_at = Column(DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False)
    
    # Relationships
    # FIXED: Use lazy="selectin" to prevent greenlet errors when accessing relationships in async context
    submission = relationship("Submission", back_populates="evaluation", lazy="selectin")
    
    def __repr__(self) -> str:
        return f"<Evaluation(id={self.id}, submission_id={self.submission_id}, final_score={self.final_score})>"
    
    @property
    def grade_letter(self) -> str:
        """Convert numeric score to letter grade."""
        if self.final_score >= 90:
            return "A"
        elif self.final_score >= 80:
            return "B"
        elif self.final_score >= 70:
            return "C"
        elif self.final_score >= 60:
            return "D"
        else:
            return "F"
    
    @property
    def is_high_ai_similarity(self) -> bool:
        """Check if AI similarity is suspiciously high (>0.8)."""
        return self.ai_similarity > 0.8
    
    @property
    def is_high_group_similarity(self) -> bool:
        """Check if group similarity is suspiciously high (>0.8)."""
        return self.intra_group_similarity > 0.8
    
    @property
    def is_suspicious(self) -> bool:
        """Check if submission shows signs of potential academic dishonesty."""
        return self.is_high_ai_similarity or self.is_high_group_similarity
    
    @property
    def originality_score(self) -> float:
        """Calculate originality score (inverse of similarity)."""
        # Weighted average: AI similarity has more weight than group similarity
        combined_similarity = (self.ai_similarity * 0.7) + (self.intra_group_similarity * 0.3)
        return max(0.0, 1.0 - combined_similarity)